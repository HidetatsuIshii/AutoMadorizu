<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autoé–“å–ã‚Šå›³</title>
    
    <!-- ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆ (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', 'Inter', sans-serif; }
        .file-upload-area {
            border: 2px dashed #d1d5db;
            transition: background-color 0.2s ease-in-out;
        }
        .file-upload-area.drag-over {
            background-color: #e0f2fe;
            border-color: #3b82f6;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
    </style>
</head>
<body>
    <div id="root">
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: sans-serif;">
            ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿ä¸­...
        </div>
    </div>

    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’bodyã®æœ€å¾Œã«ç§»å‹• -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1648.0.min.js"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/aws-amplify@4/dist/aws-amplify.min.js"></script>

    <script type="text/babel">
        // â˜… å¤‰æ›´ç‚¹: ã™ã¹ã¦ã®å‡¦ç†ã‚’ window.onload å†…ã§å®Ÿè¡Œ
        window.onload = function() {
            const { useState, useEffect, useRef } = React;
            const { Amplify, Auth, Storage } = window.aws_amplify;

            // ==================================================================================
            // 1. AWS Amplifyã®è¨­å®š
            // ==================================================================================
            const awsconfig = {
              Auth: {
                identityPoolId: 'ap-northeast-1:f7a257e9-3de2-4d6a-8a12-3241e6f9e4b1',
                region: 'ap-northeast-1',
                userPoolId: 'ap-northeast-1_fH3jt4wg6',
                userPoolWebClientId: '1nhvf8pe01vbhb1cjmng8p8n22',
              },
              Storage: {
                  AWSS3: {
                      bucket: 'automadorizu-upload-891377349958', 
                      region: 'ap-northeast-1',
                  }
              }
            };
            Amplify.configure(awsconfig);

            // ==================================================================================
            // 2. ãƒ­ã‚°è¨˜éŒ²ç”¨ã®å…±é€šé–¢æ•°
            // ==================================================================================
            const logAction = async (action, user, details = {}) => {
                const API_ENDPOINT = 'https://y5cg2tb2yc.execute-api.ap-northeast-1.amazonaws.com/v1';
                
                const logPayload = {
                    userId: user?.attributes?.sub || details.userId || null,
                    userName: user?.attributes?.name || user?.username || details.userName || 'Anonymous',
                    action: action,
                    details: details,
                };

                try {
                    await fetch(`${API_ENDPOINT}/logs`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(logPayload),
                    });
                } catch (error) {
                    console.error("Log submission failed:", error);
                }
            };

            // ==================================================================================
            // 3. ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
            // ==================================================================================
            const LoginPage = ({ onLogin, onNavigate, loading, error }) => {
              const [email, setEmail] = useState('');
              const [password, setPassword] = useState('');

              const handleSubmit = (e) => {
                e.preventDefault();
                onLogin(email, password);
              };

              return (
                <div className="min-h-screen bg-gray-50 flex flex-col justify-center items-center p-4">
                  <div className="max-w-md w-full mx-auto bg-white p-8 rounded-xl shadow-md">
                    <div className="text-center mb-8">
                      <h1 className="text-3xl font-bold text-blue-600">Autoé–“å–ã‚Šå›³</h1>
                    </div>
                    <form onSubmit={handleSubmit} className="space-y-6">
                      <div>
                        <label htmlFor="email" className="text-sm font-bold text-gray-600 block">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input id="email" type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full p-3 mt-1 bg-gray-100 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                      </div>
                      <div>
                        <label htmlFor="password" className="text-sm font-bold text-gray-600 block">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input id="password" type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full p-3 mt-1 bg-gray-100 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                      </div>
                      {error && <p className="text-sm text-red-500 text-center">{error}</p>}
                      <div>
                        <button type="submit" disabled={loading} className="w-full py-3 px-4 bg-blue-600 text-white font-bold rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400">
                          {loading ? 'å‡¦ç†ä¸­...' : 'ãƒ­ã‚°ã‚¤ãƒ³'}
                        </button>
                      </div>
                    </form>
                    <div className="text-center mt-4">
                        <button onClick={() => onNavigate('signUp')} className="text-sm text-blue-600 hover:underline">æ–°è¦ç™»éŒ²ã¯ã“ã¡ã‚‰</button>
                    </div>
                  </div>
                </div>
              );
            };
            
            // ==================================================================================
            // 4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ç”»é¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
            // ==================================================================================
            const SignUpPage = ({ onSignUp, onNavigate, loading, error }) => {
                const [name, setName] = useState('');
                const [email, setEmail] = useState('');
                const [password, setPassword] = useState('');

                const handleSubmit = (e) => {
                    e.preventDefault();
                    onSignUp(name, email, password);
                };

                return (
                    <div className="min-h-screen bg-gray-50 flex flex-col justify-center items-center p-4">
                        <div className="max-w-md w-full mx-auto bg-white p-8 rounded-xl shadow-md">
                            <div className="text-center mb-8">
                                <h1 className="text-3xl font-bold text-blue-600">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ–°è¦ç™»éŒ²</h1>
                            </div>
                            <form onSubmit={handleSubmit} className="space-y-6">
                                <div>
                                    <label htmlFor="name" className="text-sm font-bold text-gray-600 block">ãŠåå‰</label>
                                    <input id="name" type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full p-3 mt-1 bg-gray-100 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                                </div>
                                <div>
                                    <label htmlFor="signup-email" className="text-sm font-bold text-gray-600 block">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                    <input id="signup-email" type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full p-3 mt-1 bg-gray-100 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                                </div>
                                <div>
                                    <label htmlFor="signup-password" className="text-sm font-bold text-gray-600 block">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                                    <input id="signup-password" type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full p-3 mt-1 bg-gray-100 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                                </div>
                                {error && <p className="text-sm text-red-500 text-center">{error}</p>}
                                <div>
                                    <button type="submit" disabled={loading} className="w-full py-3 px-4 bg-blue-600 text-white font-bold rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400">
                                        {loading ? 'å‡¦ç†ä¸­...' : 'ç™»éŒ²ã™ã‚‹'}
                                    </button>
                                </div>
                            </form>
                            <div className="text-center mt-4">
                                <button onClick={() => onNavigate('login')} className="text-sm text-blue-600 hover:underline">ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹</button>
                            </div>
                        </div>
                    </div>
                );
            };

            // ==================================================================================
            // 5. ãƒ¡ãƒ¼ãƒ«èªè¨¼ç”»é¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
            // ==================================================================================
            const VerificationPage = ({ onVerify, onResend, email, loading, error }) => {
                const [code, setCode] = useState('');

                const handleSubmit = (e) => {
                    e.preventDefault();
                    onVerify(code);
                };

                return (
                    <div className="min-h-screen bg-gray-50 flex flex-col justify-center items-center p-4">
                        <div className="max-w-md w-full mx-auto bg-white p-8 rounded-xl shadow-md">
                            <div className="text-center mb-8">
                                <h1 className="text-2xl font-bold text-blue-600">ãƒ¡ãƒ¼ãƒ«èªè¨¼</h1>
                                <p className="text-gray-500 mt-2">{email} ã«é€ä¿¡ã•ã‚ŒãŸèªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                            </div>
                            <form onSubmit={handleSubmit} className="space-y-6">
                                <div>
                                    <label htmlFor="code" className="text-sm font-bold text-gray-600 block">èªè¨¼ã‚³ãƒ¼ãƒ‰</label>
                                    <input id="code" type="text" value={code} onChange={(e) => setCode(e.target.value)} className="w-full p-3 mt-1 bg-gray-100 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                                </div>
                                {error && <p className="text-sm text-red-500 text-center">{error}</p>}
                                <div>
                                    <button type="submit" disabled={loading} className="w-full py-3 px-4 bg-blue-600 text-white font-bold rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400">
                                        {loading ? 'å‡¦ç†ä¸­...' : 'èªè¨¼ã™ã‚‹'}
                                    </button>
                                </div>
                            </form>
                             <div className="text-center mt-4">
                                <button onClick={onResend} className="text-sm text-blue-600 hover:underline">èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å†é€ä¿¡</button>
                            </div>
                        </div>
                    </div>
                );
            };
            
            // ==================================================================================
            // 6. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
            // ==================================================================================
            const DashboardPage = ({ user, onSignOut, onNavigate }) => {
                const displayName = user && user.attributes ? (user.attributes.name || user.attributes.email) : '...';
                const [isMenuOpen, setIsMenuOpen] = useState(false);
                const menuRef = useRef(null);
                const isAdmin = user?.signInUserSession?.accessToken?.payload['cognito:groups']?.includes('Admins') ?? false;
                
                // â–¼â–¼â–¼ ä»¥ä¸‹3è¡Œã‚’è¿½åŠ  â–¼â–¼â–¼
                const [isCreateModalOpen, setCreateModalOpen] = useState(false);
                const [history, setHistory] = useState([]);
                const [loadingHistory, setLoadingHistory] = useState(true);
            
                const [searchTerm, setSearchTerm] = useState('');
                const [currentPage, setCurrentPage] = useState(1);
                const itemsPerPage = 20;
            
                // ä½œæˆå±¥æ­´ã‚’å–å¾—ã™ã‚‹é–¢æ•° (useEffectå†…ã§å‘¼ã³å‡ºã™)
                const fetchHistory = async () => {
                    setLoadingHistory(true);
                    try {
                        // â˜…â˜…â˜…â˜…â˜… ã”è‡ªèº«ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«åˆã‚ã›ã¦ãã ã•ã„ â˜…â˜…â˜…â˜…â˜…
                        const response = await fetch('https://y5cg2tb2yc.execute-api.ap-northeast-1.amazonaws.com/v1/madorizu');
                        if (!response.ok) throw new Error('ä½œæˆå±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                        const data = await response.json();
                        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã£ã¦ãã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„ (ä¾‹: data.items)
                        setHistory(data); 
                    } catch (error) {
                        console.error(error);
                        setHistory([]); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç©ºã«ã™ã‚‹
                    } finally {
                        setLoadingHistory(false);
                    }
                };
                
                useEffect(() => {
                    fetchHistory(); // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å±¥æ­´ã‚’å–å¾—
            
                    const handleClickOutside = (event) => {
                        if (menuRef.current && !menuRef.current.contains(event.target)) {
                            setIsMenuOpen(false);
                        }
                    };
                    document.addEventListener('mousedown', handleClickOutside);
                    return () => {
                        document.removeEventListener('mousedown', handleClickOutside);
                    };
                }, []);
            
                const filteredHistory = history.filter(item =>
                    (item.name && item.name.toLowerCase().includes(searchTerm.toLowerCase()))
                );
            
                const totalPages = Math.ceil(filteredHistory.length / itemsPerPage);
                const paginatedHistory = filteredHistory.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
            
                const handlePageChange = (pageNumber) => {
                    if (pageNumber < 1 || pageNumber > totalPages) return;
                    setCurrentPage(pageNumber);
                };
            
                return (
                    <> {/* ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã§å›²ã‚€ */}
                        <div className="min-h-screen bg-gray-100">
                            <header className="bg-white shadow-sm">
                                {/* ... (headerã®ä¸­èº«ã¯å¤‰æ›´ãªã—) ... */}
                            </header>
                            <main className="container mx-auto p-4 sm:p-8">
                                <div className="bg-white p-6 rounded-lg shadow-md text-center mb-8">
                                    <h2 className="text-xl font-semibold mb-4 text-gray-700">ã‚ˆã†ã“ãã€{displayName}ã•ã‚“</h2>
                                    {/* â–¼â–¼â–¼ onClickã®å‡¦ç†ã‚’å¤‰æ›´ â–¼â–¼â–¼ */}
                                    <button onClick={() => setCreateModalOpen(true)} className="bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-4 px-8 text-xl rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all transform hover:scale-105 shadow-xl flex items-center mx-auto">
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                        </svg>
                                        æ–°è¦ä½œæˆã‚’é–‹å§‹
                                    </button>
                                </div>
                                <div className="bg-white p-6 rounded-lg shadow-md">
                                    {/* ... (æ¤œç´¢ãƒãƒ¼ãªã©ã¯å¤‰æ›´ãªã—) ... */}
                                    <div className="overflow-x-auto">
                                        <ul className="divide-y divide-gray-200 min-w-[600px]">
                                            {loadingHistory ? (
                                                <li className="p-8 text-center text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</li>
                                            ) : filteredHistory.length > 0 ? paginatedHistory.map(item => (
                                                <li key={item.id} className="p-4 hover:bg-gray-50 flex flex-col sm:flex-row justify-between items-start sm:items-center">
                                                    <div className="flex items-center mb-2 sm:mb-0">
                                                        <span className="text-gray-400 mr-3">ğŸ“‹</span>
                                                        <div>
                                                            <p className="font-semibold text-gray-800">{item.name}</p>
                                                            <p className="text-sm text-gray-500">æœ€çµ‚æ›´æ–°: {new Date(item.updatedAt).toLocaleString('ja-JP')}</p>
                                                        </div>
                                                    </div>
                                                    <div className="flex space-x-2 flex-wrap">
                                                        {/* â–¼â–¼â–¼ ã€Œç·¨é›†ã€ãƒœã‚¿ãƒ³ã®onClickã‚’å¤‰æ›´ â–¼â–¼â–¼ */}
                                                        <button onClick={() => window.location.href = `edit.html?id=${item.id}`} className="text-sm bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-3 rounded-md mt-2 sm:mt-0">âœï¸ç·¨é›†</button>
                                                        <button className="text-sm text-red-500 hover:text-red-700 font-semibold py-1 px-3 rounded-md mt-2 sm:mt-0">ğŸ—‘ï¸å‰Šé™¤</button>
                                                    </div>
                                                </li>
                                            )) : (
                                                <li className="p-8 text-center text-gray-500">ä½œæˆã•ã‚ŒãŸå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
                                            )}
                                        </ul>
                                    </div>
                                     {/* ... (ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³éƒ¨åˆ†ã¯å¤‰æ›´ãªã—) ... */}
                                </div>
                            </main>
                        </div>
                        
                        {/* â–¼â–¼â–¼ ã“ã®ãƒ¢ãƒ¼ãƒ€ãƒ«å‘¼ã³å‡ºã—ã‚’è¿½åŠ  â–¼â–¼â–¼ */}
                        {isCreateModalOpen && (
                            <CreateMadorizuModal
                                onClose={() => setCreateModalOpen(false)}
                            />
                        )}
                    </>
                );
            };

            const CreateMadorizuModal = ({ onClose }) => {
                const [name, setName] = useState('');
                const [loading, setLoading] = useState(false);
                const [error, setError] = useState('');
            
                const handleCreate = async (e) => {
                    e.preventDefault();
                    if (!name.trim()) {
                        setError('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    setLoading(true);
                    setError('');
            
                    // â˜…â˜…â˜…â˜…â˜… ã”è‡ªèº«ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«æ›¸ãæ›ãˆã¦ãã ã•ã„ â˜…â˜…â˜…â˜…â˜…
                    const API_ENDPOINT = 'https://y5cg2tb2yc.execute-api.ap-northeast-1.amazonaws.com/v1/madorizu';
            
                    try {
                        // æ–°ã—ã„é–“å–ã‚Šå›³ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒãƒ¼ã«ä½œæˆã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                        const response = await fetch(API_ENDPOINT, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: name,
                                drawingData: { svgElements: [] } // ç©ºã®ãƒ‡ãƒ¼ã‚¿ã§åˆæœŸåŒ–
                            }),
                        });
            
                        if (!response.ok) {
                             const errData = await response.json(); // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’å–å¾—
                             throw new Error(errData.message || 'æ–°è¦ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                        }
            
                        const result = await response.json();
            
                        // ä½œæˆã«æˆåŠŸã—ãŸã‚‰ã€è¿”ã£ã¦ããŸIDã‚’ä»˜ã‘ã¦edit.htmlã«é·ç§»
                        if (result.id) {
                            window.location.href = `edit.html?id=${result.id}`;
                        } else {
                            throw new Error('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ‰åŠ¹ãªIDãŒè¿”ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚');
                        }
            
                    } catch (err) {
                        setError(err.message);
                        setLoading(false);
                    }
                };
            
                return (
                    <div className="modal-backdrop">
                        <div className="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                            <h3 className="text-lg font-bold mb-4">æ–°è¦é–“å–ã‚Šå›³ã®ä½œæˆ</h3>
                            <form onSubmit={handleCreate}>
                                <label htmlFor="madorizu-name" className="text-sm font-bold text-gray-600 block">é–“å–ã‚Šå›³ã®åå‰</label>
                                <input
                                    id="madorizu-name"
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    className="w-full p-3 mt-1 bg-gray-100 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    required
                                    autoFocus
                                />
                                {error && <p className="text-sm text-red-500 mt-2">{error}</p>}
                                <div className="flex justify-end space-x-3 mt-6">
                                    <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                    <button type="submit" disabled={loading} className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400">
                                        {loading ? 'ä½œæˆä¸­...' : 'ä½œæˆã—ã¦ç·¨é›†ã‚’é–‹å§‹'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            };

            // ==================================================================================
            // 7. ç®¡ç†è€…ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
            // ==================================================================================
            const AdminPage = ({ onNavigate }) => {
                const [activeTab, setActiveTab] = useState('users');
                
                const [users, setUsers] = useState([]);
                const [isUsersLoading, setIsUsersLoading] = useState(false);
                const [usersError, setUsersError] = useState('');
                const [searchTerm, setSearchTerm] = useState('');
                const [modal, setModal] = useState({ type: null, user: null });
                
                const [logs, setLogs] = useState([]);
                const [isLogsLoading, setIsLogsLoading] = useState(false);
                const [logsError, setLogsError] = useState('');
                const [logMonth, setLogMonth] = useState(new Date().toISOString().substring(0, 7));

                const API_ENDPOINT = 'https://y5cg2tb2yc.execute-api.ap-northeast-1.amazonaws.com/v1';

                const fetchUsers = async () => {
                    setIsUsersLoading(true);
                    setUsersError('');
                    try {
                        const session = await Auth.currentSession();
                        const jwtToken = session.getIdToken().getJwtToken();
                        const response = await fetch(`${API_ENDPOINT}/users`, { headers: { Authorization: jwtToken } });
                        if (!response.ok) throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                        const data = await response.json();
                        setUsers(data);
                    } catch (err) {
                        setUsersError(err.message);
                    } finally {
                        setIsUsersLoading(false);
                    }
                };

                const fetchLogs = async () => {
                    setIsLogsLoading(true);
                    setLogsError('');
                    try {
                        const session = await Auth.currentSession();
                        const jwtToken = session.getIdToken().getJwtToken();
                        const response = await fetch(`${API_ENDPOINT}/logs?month=${logMonth}`, {
                            headers: { Authorization: jwtToken },
                        });
                        if (!response.ok) throw new Error('ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                        const data = await response.json();
                        setLogs(data);
                    } catch (err) {
                        setLogsError(err.message);
                    } finally {
                        setIsLogsLoading(false);
                    }
                };

                useEffect(() => {
                    if (activeTab === 'users') {
                        fetchUsers();
                    } else if (activeTab === 'logs') {
                        fetchLogs();
                    }
                }, [activeTab, logMonth]);

                const handleUpdateUserStatus = async (user, action) => {
                    try {
                        const session = await Auth.currentSession();
                        const jwtToken = session.getIdToken().getJwtToken();
                        const username = user.email;
                        await fetch(`${API_ENDPOINT}/users/${encodeURIComponent(username)}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json', Authorization: jwtToken },
                            body: JSON.stringify({ action: action }),
                        });
                        fetchUsers();
                        setModal({ type: null, user: null });
                    } catch (err) {
                        setUsersError(err.message);
                    }
                };

                const handleDeleteUser = async (user) => {
                    try {
                        const session = await Auth.currentSession();
                        const jwtToken = session.getIdToken().getJwtToken();
                        const username = user.email;
                        await fetch(`${API_ENDPOINT}/users/${encodeURIComponent(username)}`, {
                            method: 'DELETE',
                            headers: { Authorization: jwtToken },
                        });
                        setUsers(prevUsers => prevUsers.filter(u => u.userId !== user.userId));
                        setModal({ type: null, user: null });
                    } catch (err) {
                        setUsersError(err.message);
                    }
                };
                
                const filteredUsers = users.filter(user => (user.name && user.name.toLowerCase().includes(searchTerm.toLowerCase())) || (user.email && user.email.toLowerCase().includes(searchTerm.toLowerCase())));
                
                const getStatusLabel = (status) => {
                    switch (status) {
                        case 'CONFIRMED': return 'åˆ©ç”¨å¯èƒ½';
                        case 'UNCONFIRMED': return 'ãƒ¡ãƒ¼ãƒ«æœªç¢ºèª';
                        case 'FORCE_CHANGE_PASSWORD': return 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å¾…ã¡';
                        case 'DISABLED': return 'ç„¡åŠ¹';
                        case 'ARCHIVED': return 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿';
                        case 'COMPROMISED': return 'ä¾µå®³ã®ç–‘ã„';
                        default: return status || 'ä¸æ˜';
                    }
                };

                const getStatusBadgeClass = (status) => {
                    switch (status) {
                        case 'CONFIRMED': return 'bg-green-100 text-green-800';
                        case 'UNCONFIRMED':
                        case 'FORCE_CHANGE_PASSWORD': return 'bg-yellow-100 text-yellow-800';
                        case 'DISABLED': return 'bg-gray-200 text-gray-800';
                        case 'ARCHIVED':
                        case 'COMPROMISED': return 'bg-red-100 text-red-800';
                        default: return 'bg-gray-100 text-gray-800';
                    }
                };
                
                const getActionLabel = (action) => {
                    const labels = {
                        'LOGIN_SUCCESS': 'ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ',
                        'LOGIN_FAILURE': 'ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—',
                        'LOGOUT': 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
                        'PROFILE_UPDATE': 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å¤‰æ›´',
                        'CREATE_STARTED': 'æ–°è¦ä½œæˆé–‹å§‹',
                        'GENERATE_FLOORPLAN': 'é–“å–ã‚Šå›³ç”Ÿæˆ',
                        'PREVIEW_FLOORPLAN': 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º',
                        'DOWNLOAD_PDF': 'PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
                        'ADMIN_UPDATE_USER': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹å¤‰æ›´',
                        'ADMIN_DELETE_USER': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤',
                    };
                    return labels[action] || action;
                };

                const handleMonthChange = (increment) => {
                    const currentDate = new Date(`${logMonth}-02`);
                    currentDate.setMonth(currentDate.getMonth() + increment);
                    setLogMonth(currentDate.toISOString().substring(0, 7));
                };

                return (
                    <>
                        {modal.type === 'edit' && modal.user && ( <EditUserModal user={modal.user} onClose={() => setModal({ type: null, user: null })} onUpdate={handleUpdateUserStatus} getStatusLabel={getStatusLabel}/> )}
                        {modal.type === 'delete' && modal.user && ( <DeleteUserModal user={modal.user} onClose={() => setModal({ type: null, user: null })} onConfirm={handleDeleteUser}/> )}

                        <div className="min-h-screen bg-gray-100">
                            <header className="bg-white shadow-sm">
                                <nav className="container mx-auto px-4 sm:px-6 lg:px-8">
                                    <div className="flex items-center justify-between h-16">
                                        <h1 className="text-xl font-bold text-red-600">ç®¡ç†è€…ãƒšãƒ¼ã‚¸</h1>
                                        <button onClick={() => onNavigate('dashboard')} className="text-sm text-blue-600 hover:underline">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
                                    </div>
                                </nav>
                            </header>
                            <main className="container mx-auto p-4 sm:p-8">
                                <div className="mb-4 border-b border-gray-200">
                                    <nav className="-mb-px flex space-x-8" aria-label="Tabs">
                                        <button onClick={() => setActiveTab('users')} className={`${activeTab === 'users' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`}>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</button>
                                        <button onClick={() => setActiveTab('logs')} className={`${activeTab === 'logs' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`}>åˆ©ç”¨çŠ¶æ³ãƒ­ã‚°</button>
                                    </nav>
                                </div>

                                {activeTab === 'users' && (
                                    <>
                                    {usersError && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">{usersError}</div>}
                                    {isUsersLoading ? ( <div className="text-center p-8">èª­ã¿è¾¼ã¿ä¸­...</div> ) : (
                                        <div className="bg-white p-6 rounded-lg shadow-md">
                                            <h2 className="text-2xl font-bold mb-4">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h2>
                                            <div className="mb-4">
                                                <input type="text" placeholder="åå‰ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§æ¤œç´¢..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                            </div>
                                            <div className="overflow-x-auto">
                                                <table className="min-w-full divide-y divide-gray-200">
                                                    <thead className="bg-gray-50">
                                                        <tr>
                                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åå‰</th>
                                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚</th>
                                                            <th scope="col" className="relative px-6 py-3"><span className="sr-only">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</span></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="bg-white divide-y divide-gray-200">
                                                        {filteredUsers.map(user => (
                                                            <tr key={user.userId}>
                                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{user.name}</td>
                                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{user.email}</td>
                                                                <td className="px-6 py-4 whitespace-nowrap">
                                                                    <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadgeClass(user.status)}`}>
                                                                        {getStatusLabel(user.status)}
                                                                    </span>
                                                                </td>
                                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{user.lastLogin ? new Date(user.lastLogin).toLocaleString('ja-JP') : 'N/A'}</td>
                                                                <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                                    <button onClick={() => setModal({ type: 'edit', user: user })} className="text-blue-600 hover:text-blue-900">ç·¨é›†</button>
                                                                    <button onClick={() => setModal({ type: 'delete', user: user })} className="text-red-600 hover:text-red-900 ml-4">å‰Šé™¤</button>
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    )}
                                    </>
                                )}

                                {activeTab === 'logs' && (
                                    <div className="bg-white p-6 rounded-lg shadow-md">
                                        <div className="flex justify-between items-center mb-4">
                                            <h2 className="text-2xl font-bold">åˆ©ç”¨çŠ¶æ³ãƒ­ã‚°</h2>
                                            <div className="flex items-center space-x-2">
                                                <button onClick={() => handleMonthChange(-1)} className="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">â€¹ å‰æœˆ</button>
                                                <span className="font-semibold text-lg">{logMonth}</span>
                                                <button onClick={() => handleMonthChange(1)} className="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">æ¬¡æœˆ â€º</button>
                                            </div>
                                        </div>
                                        
                                        {logsError && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">{logsError}</div>}
                                        
                                        {isLogsLoading ? (<div className="text-center p-8">èª­ã¿è¾¼ã¿ä¸­...</div>) : (
                                            <div className="overflow-x-auto">
                                                <table className="min-w-full divide-y divide-gray-200">
                                                    <thead className="bg-gray-50">
                                                        <tr>
                                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ—¥æ™‚</th>
                                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IPã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="bg-white divide-y divide-gray-200">
                                                        {logs.length > 0 ? logs.map(log => (
                                                            <tr key={log.logId}>
                                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{new Date(log.timestamp).toLocaleString('ja-JP')}</td>
                                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{log.userName}</td>
                                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{getActionLabel(log.action)}</td>
                                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{log.ipAddress}</td>
                                                            </tr>
                                                        )) : (
                                                            <tr>
                                                                <td colSpan="4" className="px-6 py-8 text-center text-gray-500">ã“ã®æœˆã®ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td>
                                                            </tr>
                                                        )}
                                                    </tbody>
                                                </table>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </main>
                        </div>
                    </>
                );
            };

            // ==================================================================================
            // 8. ãƒ¢ãƒ¼ãƒ€ãƒ«ç­‰ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
            // ==================================================================================
            const EditUserModal = ({ user, onClose, onUpdate, getStatusLabel }) => {
                return (
                    <div className="modal-backdrop">
                        <div className="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                            <h3 className="text-lg font-bold mb-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ç·¨é›†</h3>
                            <p className="mb-4 text-sm text-gray-600">{user.name} ({user.email})</p>
                            
                            <div className="mb-4">
                                <p className="text-sm font-medium text-gray-700">ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: {getStatusLabel(user.status)}</p>
                            </div>

                            <div className="flex justify-end space-x-3 mt-6">
                                <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                {user.enabled ? (
                                    <button onClick={() => onUpdate(user, 'disable')} className="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç„¡åŠ¹åŒ–</button>
                                ) : (
                                    <button onClick={() => onUpdate(user, 'enable')} className="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æœ‰åŠ¹åŒ–</button>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            const DeleteUserModal = ({ user, onClose, onConfirm }) => {
                return (
                    <div className="modal-backdrop">
                        <div className="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                            <h3 className="text-lg font-bold text-red-600 mb-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‰Šé™¤</h3>
                            <p className="mb-4 text-sm text-gray-700">
                                æœ¬å½“ã« <strong>{user.name} ({user.email})</strong> ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ<br/>
                                ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
                            </p>
                            <div className="flex justify-end space-x-3 mt-6">
                                <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                <button onClick={() => onConfirm(user)} className="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">å‰Šé™¤ã‚’å®Ÿè¡Œ</button>
                            </div>
                        </div>
                    </div>
                );
            };
            
            const ProfilePage = ({ user, onNavigate, onProfileUpdate }) => {
                const [name, setName] = useState(user.attributes.name || '');
                const [email, setEmail] = useState(user.attributes.email || '');
                const [loading, setLoading] = useState(false);
                const [error, setError] = useState('');
                const [success, setSuccess] = useState('');
                const isMounted = useRef(true);

                useEffect(() => {
                    isMounted.current = true;
                    return () => {
                        isMounted.current = false;
                    };
                }, []);

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    if (!isMounted.current) return;
                    setLoading(true);
                    setError('');
                    setSuccess('');
                    try {
                        await onProfileUpdate({ name, email });
                        if (isMounted.current) {
                            setSuccess('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¤‰æ›´ã—ãŸå ´åˆã¯ã€èªè¨¼ãŒå¿…è¦ã§ã™ã€‚');
                        }
                    } catch(err) {
                        if (isMounted.current) {
                            setError(err.message || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                        }
                    } finally {
                        if (isMounted.current) {
                            setLoading(false);
                        }
                    }
                };

                return (
                    <div className="min-h-screen bg-gray-100">
                         <header className="bg-white shadow-sm">
                            <nav className="container mx-auto px-4 sm:px-6 lg:px-8">
                                <div className="flex items-center justify-between h-16">
                                    <h1 className="text-xl font-bold text-gray-800">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h1>
                                    <button onClick={() => onNavigate('dashboard')} className="text-sm text-blue-600 hover:underline">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
                                </div>
                            </nav>
                        </header>
                        <main className="container mx-auto p-4 sm:p-8">
                            <div className="max-w-xl mx-auto bg-white p-8 rounded-xl shadow-md">
                                 <form onSubmit={handleSubmit} className="space-y-6">
                                    <div>
                                        <label htmlFor="profile-name" className="text-sm font-bold text-gray-600 block">ãŠåå‰</label>
                                        <input id="profile-name" type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full p-3 mt-1 bg-gray-100 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                                    </div>
                                    <div>
                                        <label htmlFor="profile-email" className="text-sm font-bold text-gray-600 block">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                        <input id="profile-email" type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full p-3 mt-1 bg-gray-100 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                                    </div>
                                    {error && <p className="text-sm text-red-500 text-center">{error}</p>}
                                    {success && <p className="text-sm text-green-500 text-center">{success}</p>}
                                    <div>
                                        <button type="submit" disabled={loading} className="w-full py-3 px-4 bg-blue-600 text-white font-bold rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400">
                                            {loading ? 'æ›´æ–°ä¸­...' : 'å¤‰æ›´ã‚’ä¿å­˜'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </main>
                    </div>
                );
            };


            // ==================================================================================
            // 10. ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (App)
            // ==================================================================================
            function App() {
              const [user, setUser] = useState(undefined);
              const [loading, setLoading] = useState(false);
              const [error, setError] = useState('');
              const [view, setView] = useState('login'); 
              const [verificationEmail, setVerificationEmail] = useState('');

              const fetchUser = async () => {
                  try {
                    const currentUser = await Auth.currentAuthenticatedUser({ bypassCache: true });
                    setUser(currentUser);
                    setView('dashboard');
                  } catch (error) {
                    setUser(null);
                    setView('login');
                  }
              };

              useEffect(() => {
                fetchUser();
              }, []);

              const handleLogin = async (email, password) => {
                if (loading) return;
                setLoading(true);
                setError('');
                try {
                  const loggedInUser = await Auth.signIn(email, password);
                  await logAction('LOGIN_SUCCESS', loggedInUser);
                  setUser(loggedInUser);
                  setView('dashboard');
                } catch (err) {
                  await logAction('LOGIN_FAILURE', null, { userName: email, error: err.message });
                  setError(err.message || 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
                } finally {
                  setLoading(false);
                }
              };

              const handleSignUp = async (name, email, password) => {
                if (loading) return;
                setLoading(true);
                setError('');
                try {
                    await Auth.signUp({ username: email, password, attributes: { name, email } });
                    setVerificationEmail(email);
                    setView('verify');
                } catch (err) {
                    setError(err.message || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                } finally {
                    setLoading(false);
                }
              };
              
              const handleVerification = async (code) => {
                if (loading) return;
                setLoading(true);
                setError('');
                try {
                    await Auth.confirmSignUp(verificationEmail, code);
                    alert('èªè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                    setView('login');
                } catch (err) {
                    setError(err.message || 'èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                } finally {
                    setLoading(false);
                }
              };
              
              const handleResendCode = async () => {
                  try {
                      await Auth.resendSignUp(verificationEmail);
                      alert('èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å†é€ä¿¡ã—ã¾ã—ãŸã€‚');
                  } catch (err) {
                      alert(err.message || 'å†é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                  }
              };
              
              const handleProfileUpdate = async (attributes) => {
                  const currentUser = await Auth.currentAuthenticatedUser();
                  await Auth.updateUserAttributes(currentUser, attributes);
                  await fetchUser();
              };

              const handleSignOut = async () => {
                try {
                  await logAction('LOGOUT', user);
                  await Auth.signOut();
                  setUser(null);
                  setView('login');
                } catch (error) {
                  console.error('Error signing out: ', error);
                }
              };
              
              if (user === undefined) {
                return <div className="min-h-screen flex items-center justify-center">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç¢ºèªä¸­...</div>;
              }

              if (view === 'login') {
                return <LoginPage onLogin={handleLogin} onNavigate={setView} loading={loading} error={error} />;
              }
              if (view === 'signUp') {
                return <SignUpPage onSignUp={handleSignUp} onNavigate={setView} loading={loading} error={error} />;
              }
              if (view === 'verify') {
                return <VerificationPage onVerify={handleVerification} onResend={handleResendCode} email={verificationEmail} loading={loading} error={error} />;
              }
              if (user) {
                  if (view === 'dashboard') {
                    return <DashboardPage user={user} onSignOut={handleSignOut} onNavigate={setView} />;
                  }
                  if (view === 'profile') {
                    return <ProfilePage user={user} onNavigate={setView} onProfileUpdate={handleProfileUpdate} />;
                  }
                  if (view === 'admin') {
                    return <AdminPage onNavigate={setView} />;
                  }
              }
              
              return <LoginPage onLogin={handleLogin} onNavigate={setView} loading={loading} error={error} />;
            }

            ReactDOM.render(<App />, document.getElementById('root'));
        };
    </script>
</body>
</html>
